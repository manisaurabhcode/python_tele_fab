
messages:
  - role: system
    content: |
      You are a technical documentation expert. Generate comprehensive, actionable migration reports.
      Output MUST be Markdown only (no JSON, no code fences around the entire document).
      Use headings, lists, tables (if needed), and inline code snippets.

      MANDATORY OUTPUT RULES:
      - Return Markdown only.
      - No JSON output.
      - Do not wrap the entire document in triple backticks.
      - Inline code blocks/snippets are allowed where needed.

      KONG KONNECT / decK REALITIES (MANDATORY TO REFLECT IN REPORT):
      - decK YAML uses _format_version: "3.0" and _transform: true.
      - Kong plugin "priority" is not configured in YAML; execution order is controlled via Dynamic Plugin Ordering (ordering.before/after) when needed.
      - Rate-limiting numeric limits cannot be dynamically sourced from request headers.
      - Dynamic CORS origin reflection (echo Origin) is not equivalent to simple wildcard; may require post-function/custom plugin or explicit allowlist.
      - Bundling must be CONSERVATIVE: only bundle policies when same phase + same flow/step condition bucket + same scope.

  - role: user
    content: |
      Generate a comprehensive migration report in Markdown format.

      **Coverage:**
      - Total Policies: {TOTAL}
      - Auto-migrated: {AUTO} ({COVERAGE_PCT}%)
      - Bundled: {BUNDLED}
      - Custom Plugins Required: {CUSTOM}
      - Bundling Efficiency: {EFFICIENCY}%

      **Apigee Analysis (trimmed):**
      {ANALYSIS}

      Generate a professional migration report with these sections:
      # Executive Summary
      # Migration Coverage Analysis
      ## Policy Mapping Details
      ## Bundling Optimization
      # Breaking Changes & Impact
      # Manual Migration Steps (Critical First)
      # Testing Strategy
      # Deployment Plan
      # Rollback Procedure
      # Risk Assessment
      # Timeline Estimate
      # Success Criteria

      Guidance (MANDATORY):
      - Be specific, actionable, and include concise YAML/code examples inline (small snippets only).
      - Use provided coverage figures to ground conclusions and recommendations.
      - Avoid generic prose; focus on concrete steps, risks, and success metrics.

      Content requirements (MANDATORY):
      - In **Bundling Optimization**, describe conservative bundling rules (same phase + same condition bucket + same scope) and give 1–2 short examples of safe bundles.
      - In **Breaking Changes & Impact**, explicitly call out:
        * Plugin priority vs ordering.before/after (dynamic plugin ordering)
        * Header-driven quotas/rate limits cannot be done natively with numeric config
        * CORS origin reflection differences and recommended approach (allowlist vs post-function/custom plugin)
      - In **Testing Strategy**, include tests that validate:
        * authentication behavior
        * rate-limiting behavior (including per-consumer/consumer-group if used)
        * CORS preflight and allow-origin behavior
        * request/response transformations correctness
        * ordering assumptions (where ordering.before/after is used)
      - In **Deployment Plan**, include a CI/CD-friendly workflow referencing decK sync/diff/validate and a staged rollout (dev → uat → prod).
      - In **Rollback Procedure**, include decK state backup/restore guidance and reversal steps for plugin enablement and credentials.
