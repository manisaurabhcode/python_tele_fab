{
    "coverage": {
        "auto_migrated": 7,
        "bundled_policies": 7,
        "bundling_efficiency": 0.0,
        "coverage_percentage": 78.0,
        "not_required": 1,
        "policy_details": [
            {
                "apigee_policy": "SA-SpikeArrest",
                "apigee_policy_type": "Traffic Management",
                "auto_generated": true,
                "bundled_with": [
                    "verify-api-key",
                    "impose-quota"
                ],
                "confidence": 0.95,
                "custom_plugin_name": null,
                "kong_plugin": "rate-limiting-advanced",
                "kong_solution": "Bundled with authentication and quota in rate-limiting-advanced plugin",
                "reasoning": "3ps rate limit efficiently handled by Kong's rate-limiting-advanced with sliding window and consumer identification",
                "requires_custom_plugin": false
            },
            {
                "apigee_policy": "verify-api-key",
                "apigee_policy_type": "Security",
                "auto_generated": true,
                "bundled_with": [
                    "remove-query-param-apikey",
                    "SA-SpikeArrest",
                    "impose-quota"
                ],
                "confidence": 1.0,
                "custom_plugin_name": null,
                "kong_plugin": "key-auth",
                "kong_solution": "Bundled authentication with credential hiding and rate limiting",
                "reasoning": "Perfect mapping to key-auth plugin with query parameter support and credential hiding",
                "requires_custom_plugin": false
            },
            {
                "apigee_policy": "remove-query-param-apikey",
                "apigee_policy_type": "Mediation",
                "auto_generated": true,
                "bundled_with": [
                    "verify-api-key"
                ],
                "confidence": 1.0,
                "custom_plugin_name": null,
                "kong_plugin": "key-auth",
                "kong_solution": "Integrated into key-auth plugin configuration",
                "reasoning": "hide_credentials: true in key-auth plugin automatically removes API key from request",
                "requires_custom_plugin": false
            },
            {
                "apigee_policy": "Security-JSONProtection",
                "apigee_policy_type": "Security",
                "auto_generated": true,
                "bundled_with": [
                    "Security-JSONTP",
                    "Security-RegExCheck"
                ],
                "confidence": 0.85,
                "custom_plugin_name": null,
                "kong_plugin": "pre-function",
                "kong_solution": "Bundled security validation using request-size-limiting and custom Lua logic",
                "reasoning": "Complex JSON structure validation implemented via custom Lua script with identical limits (depth: 10, entries: 15, key length: 50, value length: 500)",
                "requires_custom_plugin": false
            },
            {
                "apigee_policy": "Security-JSONTP",
                "apigee_policy_type": "Security",
                "auto_generated": true,
                "bundled_with": [
                    "Security-JSONProtection",
                    "Security-RegExCheck"
                ],
                "confidence": 0.9,
                "custom_plugin_name": null,
                "kong_plugin": "pre-function",
                "kong_solution": "Consolidated with Security-JSONProtection as duplicate policy",
                "reasoning": "Duplicate policy with identical configuration merged into single Lua implementation for efficiency",
                "requires_custom_plugin": false
            },
            {
                "apigee_policy": "Security-RegExCheck",
                "apigee_policy_type": "Security",
                "auto_generated": true,
                "bundled_with": [
                    "Security-JSONProtection",
                    "Security-JSONTP"
                ],
                "confidence": 0.8,
                "custom_plugin_name": null,
                "kong_plugin": "pre-function",
                "kong_solution": "Bundled SQL injection protection in custom Lua security validation",
                "reasoning": "SQL injection patterns (delete, exec, drop table, insert, shutdown, update, or) implemented in Lua script for query parameter validation",
                "requires_custom_plugin": false
            },
            {
                "apigee_policy": "VerifyJWT",
                "apigee_policy_type": "Security",
                "auto_generated": false,
                "bundled_with": [],
                "confidence": 0.0,
                "custom_plugin_name": null,
                "kong_plugin": null,
                "kong_solution": "Not implemented - requires separate JWT plugin configuration",
                "reasoning": "JWT verification not included in current Kong configuration - would require jwt plugin with HS256 algorithm and specific claims validation",
                "requires_custom_plugin": false
            },
            {
                "apigee_policy": "impose-quota",
                "apigee_policy_type": "Traffic Management",
                "auto_generated": true,
                "bundled_with": [
                    "SA-SpikeArrest",
                    "verify-api-key"
                ],
                "confidence": 0.9,
                "custom_plugin_name": null,
                "kong_plugin": "rate-limiting-advanced",
                "kong_solution": "Bundled monthly quota enforcement with rate limiting",
                "reasoning": "Monthly quota (2000 requests/30 days) implemented as separate rate-limiting-advanced instance with sliding window",
                "requires_custom_plugin": false
            },
            {
                "apigee_policy": "ResponseCache",
                "apigee_policy_type": "Performance",
                "auto_generated": false,
                "bundled_with": [],
                "confidence": 0.0,
                "custom_plugin_name": null,
                "kong_plugin": null,
                "kong_solution": "Not implemented - requires proxy-cache plugin configuration",
                "reasoning": "Response caching with 300-second TTL and cache key based on request URI not included in current Kong configuration",
                "requires_custom_plugin": false
            }
        ],
        "requires_custom_plugin": 0,
        "total_policies": 9
    },
    "custom_plugins": {},
    "kong_config": {
        "_format_version": "3.0",
        "_transform": true,
        "consumers": [
            {
                "custom_id": "petstore-default",
                "tags": [
                    "petstore",
                    "default-consumer",
                    "apigee-migration"
                ],
                "username": "default-petstore-consumer"
            }
        ],
        "jwt_secrets": [
            {
                "algorithm": "HS256",
                "consumer": "default-petstore-consumer",
                "key": "urn://apigee-edge-JWT-policy-test",
                "secret": "your-secret-key-here",
                "tags": [
                    "jwt-secret",
                    "petstore"
                ]
            }
        ],
        "keyauth_credentials": [
            {
                "consumer": "default-petstore-consumer",
                "key": "default-api-key-12345",
                "tags": [
                    "default-key",
                    "petstore"
                ]
            }
        ],
        "services": [
            {
                "name": "petstore-api",
                "plugins": [
                    {
                        "config": {
                            "hide_credentials": true,
                            "key_in_body": false,
                            "key_in_header": false,
                            "key_in_query": true,
                            "key_names": [
                                "apikey"
                            ]
                        },
                        "enabled": true,
                        "name": "key-auth",
                        "protocols": [
                            "http",
                            "https"
                        ],
                        "tags": [
                            "auth-bundle",
                            "apigee-verify-api-key"
                        ]
                    },
                    {
                        "config": {
                            "header_name": "X-RateLimit-Remaining",
                            "hide_client_headers": false,
                            "identifier": "consumer",
                            "limit": [
                                3
                            ],
                            "namespace": "petstore_rate_limit",
                            "strategy": "cluster",
                            "sync_rate": 10,
                            "window_size": [
                                1
                            ],
                            "window_type": "sliding"
                        },
                        "enabled": true,
                        "name": "rate-limiting-advanced",
                        "protocols": [
                            "http",
                            "https"
                        ],
                        "tags": [
                            "rate-limit-bundle",
                            "apigee-spike-arrest"
                        ]
                    },
                    {
                        "config": {
                            "header_name": "X-Quota-Remaining",
                            "hide_client_headers": false,
                            "identifier": "consumer",
                            "limit": [
                                2000
                            ],
                            "namespace": "petstore_monthly_quota",
                            "strategy": "cluster",
                            "sync_rate": 10,
                            "window_size": [
                                2592000
                            ],
                            "window_type": "sliding"
                        },
                        "enabled": true,
                        "instance_name": "monthly-quota",
                        "name": "rate-limiting-advanced",
                        "protocols": [
                            "http",
                            "https"
                        ],
                        "tags": [
                            "quota-bundle",
                            "apigee-impose-quota"
                        ]
                    },
                    {
                        "config": {
                            "allowed_payload_size": 512000
                        },
                        "enabled": true,
                        "name": "request-size-limiting",
                        "protocols": [
                            "http",
                            "https"
                        ],
                        "tags": [
                            "security-bundle",
                            "apigee-json-protection"
                        ]
                    },
                    {
                        "config": {
                            "access": [
                                "-- JSON Threat Protection (Security-JSONProtection + Security-JSONTP)\nlocal cjson = require \"cjson\"\nlocal body = kong.request.get_raw_body()\n\nif body and kong.request.get_header(\"content-type\") and \n   string.find(kong.request.get_header(\"content-type\"), \"application/json\") then\n  local ok, json_data = pcall(cjson.decode, body)\n  if ok then\n    local function validate_json_structure(obj, depth)\n      if depth > 10 then  -- container_depth limit\n        return false, \"JSON depth exceeds limit\"\n      end\n      \n      if type(obj) == \"table\" then\n        local count = 0\n        for k, v in pairs(obj) do\n          count = count + 1\n          if count > 15 then  -- object_entry_count limit\n            return false, \"Object entry count exceeds limit\"\n          end\n          if type(k) == \"string\" and string.len(k) > 50 then  -- object_entry_name_length\n            return false, \"Object key length exceeds limit\"\n          end\n          if type(v) == \"string\" and string.len(v) > 500 then  -- string_value_length\n            return false, \"String value length exceeds limit\"\n          end\n          if type(v) == \"table\" then\n            local valid, err = validate_json_structure(v, depth + 1)\n            if not valid then return false, err end\n          end\n        end\n      end\n      return true\n    end\n    \n    local valid, err = validate_json_structure(json_data, 1)\n    if not valid then\n      kong.response.exit(400, {error = \"JSON validation failed: \" .. err})\n    end\n  end\nend\n\n-- SQL Injection Protection (Security-RegExCheck)\nlocal malicious_patterns = {\"delete\", \"exec\", \"drop table\", \"insert\", \"shutdown\", \"update\", \"or\"}\nlocal query_params = kong.request.get_query()\n\nfor param_name, param_value in pairs(query_params) do\n  if type(param_value) == \"string\" then\n    local lower_value = string.lower(param_value)\n    for _, pattern in ipairs(malicious_patterns) do\n      if string.find(lower_value, pattern, 1, true) then\n        kong.response.exit(400, {error = \"Malicious query parameter detected\"})\n      end\n    end\n  end\nend\n"
                            ]
                        },
                        "enabled": true,
                        "name": "pre-function",
                        "protocols": [
                            "http",
                            "https"
                        ],
                        "tags": [
                            "security-bundle",
                            "apigee-security-validation"
                        ]
                    },
                    {
                        "config": {
                            "cache_control": false,
                            "cache_ttl": 3600,
                            "content_type": [
                                "text/plain",
                                "application/json",
                                "text/html"
                            ],
                            "memory": {
                                "dictionary_name": "kong_db_cache"
                            },
                            "request_method": [
                                "GET",
                                "HEAD"
                            ],
                            "response_code": [
                                200,
                                301,
                                404
                            ],
                            "storage_ttl": 3600,
                            "strategy": "memory",
                            "vary_headers": [
                                "Accept",
                                "Accept-Encoding"
                            ],
                            "vary_query_params": []
                        },
                        "enabled": true,
                        "name": "proxy-cache-advanced",
                        "protocols": [
                            "http",
                            "https"
                        ],
                        "tags": [
                            "caching",
                            "apigee-response-cache"
                        ]
                    },
                    {
                        "config": {
                            "credentials": false,
                            "exposed_headers": [],
                            "headers": [
                                "origin",
                                "x-requested-with",
                                "accept",
                                "content-type",
                                "authorization"
                            ],
                            "max_age": 3628800,
                            "methods": [
                                "GET",
                                "PUT",
                                "POST",
                                "DELETE",
                                "OPTIONS"
                            ],
                            "origins": [
                                "*"
                            ],
                            "preflight_continue": false
                        },
                        "enabled": true,
                        "name": "cors",
                        "protocols": [
                            "http",
                            "https"
                        ],
                        "tags": [
                            "cors",
                            "apigee-add-cors"
                        ]
                    }
                ],
                "routes": [
                    {
                        "methods": [
                            "GET"
                        ],
                        "name": "list-pets",
                        "paths": [
                            "/petstore-api/pets"
                        ],
                        "preserve_host": false,
                        "strip_path": true,
                        "tags": [
                            "pets",
                            "list-operation",
                            "apigee-listPets"
                        ]
                    },
                    {
                        "methods": [
                            "POST"
                        ],
                        "name": "create-pets",
                        "paths": [
                            "/petstore-api/pets"
                        ],
                        "plugins": [
                            {
                                "config": {
                                    "functions": [
                                        "return function(conf)\n  local cjson = require \"cjson\"\n  local body = kong.response.get_raw_body()\n  \n  if body and kong.response.get_header(\"content-type\") and \n     string.find(kong.response.get_header(\"content-type\"), \"application/json\") then\n    local ok, json_data = pcall(cjson.decode, body)\n    if ok then\n      -- Simple JSON to XML conversion\n      local function json_to_xml(obj, root_name)\n        root_name = root_name or \"Root\"\n        local xml = \"<\" .. root_name .. \">\"\n        \n        if type(obj) == \"table\" then\n          for k, v in pairs(obj) do\n            if type(v) == \"table\" then\n              xml = xml .. \"<\" .. k .. \">\" .. json_to_xml(v, \"Item\") .. \"</\" .. k .. \">\"\n            elseif v == nil then\n              xml = xml .. \"<\" .. k .. \">NULL</\" .. k .. \">\"\n            else\n              xml = xml .. \"<\" .. k .. \">\" .. tostring(v) .. \"</\" .. k .. \">\"\n            end\n          end\n        else\n          xml = xml .. tostring(obj)\n        end\n        \n        xml = xml .. \"</\" .. root_name .. \">\"\n        return xml\n      end\n      \n      local xml_body = json_to_xml(json_data, \"Root\")\n      kong.response.set_raw_body(xml_body)\n      kong.response.set_header(\"content-type\", \"application/xml\")\n    end\n  end\nend\n"
                                    ],
                                    "transform": {
                                        "json": [
                                            "if response.status == 200 then response.headers['content-type'] = 'application/xml' end"
                                        ]
                                    }
                                },
                                "enabled": true,
                                "name": "response-transformer-advanced",
                                "tags": [
                                    "transformation",
                                    "apigee-json-xml"
                                ]
                            }
                        ],
                        "preserve_host": false,
                        "strip_path": true,
                        "tags": [
                            "pets",
                            "create-operation",
                            "apigee-createPets"
                        ]
                    },
                    {
                        "methods": [
                            "GET"
                        ],
                        "name": "show-pet-by-id",
                        "paths": [
                            "/petstore-api/pets/"
                        ],
                        "plugins": [
                            {
                                "config": {
                                    "algorithm": "HS256",
                                    "anonymous": null,
                                    "claims_to_verify": [
                                        "exp",
                                        "sub"
                                    ],
                                    "cookie_names": [],
                                    "header_names": [
                                        "authorization"
                                    ],
                                    "key_claim_name": "iss",
                                    "maximum_expiration": 0,
                                    "run_on_preflight": true,
                                    "secret_is_base64": false,
                                    "uri_param_names": [
                                        "jwt"
                                    ]
                                },
                                "enabled": true,
                                "name": "jwt",
                                "tags": [
                                    "jwt-auth",
                                    "apigee-verify-jwt"
                                ]
                            }
                        ],
                        "preserve_host": false,
                        "strip_path": true,
                        "tags": [
                            "pets",
                            "show-operation",
                            "apigee-showPetById"
                        ]
                    }
                ],
                "tags": [
                    "apigee-migration",
                    "petstore",
                    "production"
                ],
                "url": "http://petstore.swagger.io/v1"
            }
        ]
    },
    "manual_steps": [
        {
            "category": "Preparation",
            "code_snippets": {
                "backup_script.sh": "#!/bin/bash\necho 'Creating Kong configuration backup...'\nkong config db_export kong_backup_$(date +%Y%m%d_%H%M%S).yaml\necho 'Backup completed successfully'"
            },
            "commands": [
                "kong config db_export kong_backup.yaml",
                "kubectl get services,routes,plugins -o yaml > apigee_migration_backup.yaml"
            ],
            "description": "Prepare Kong environment and backup existing configurations before migration",
            "estimated_time": "30 minutes",
            "priority": "critical",
            "step_number": 1,
            "title": "Environment Setup and Backup"
        },
        {
            "category": "Configuration",
            "code_snippets": {
                "create_service.sh": "#!/bin/bash\ncurl -i -X POST http://kong-admin:8001/services \\\n  --data 'name=petstore-api' \\\n  --data 'url=http://petstore.swagger.io/v1' \\\n  --data 'protocol=http' \\\n  --data 'connect_timeout=60000' \\\n  --data 'write_timeout=60000' \\\n  --data 'read_timeout=60000'"
            },
            "commands": [
                "curl -i -X POST http://kong-admin:8001/services --data 'name=petstore-api' --data 'url=http://petstore.swagger.io/v1'"
            ],
            "description": "Create the main Kong service that will proxy requests to the petstore backend",
            "estimated_time": "15 minutes",
            "priority": "critical",
            "step_number": 2,
            "title": "Create Kong Service for Petstore API"
        },
        {
            "category": "Configuration",
            "code_snippets": {
                "create_route.sh": "#!/bin/bash\ncurl -i -X POST http://kong-admin:8001/services/petstore-api/routes \\\n  --data 'name=petstore-api-route' \\\n  --data 'paths[]=/petstore-api' \\\n  --data 'strip_path=true' \\\n  --data 'preserve_host=false'"
            },
            "commands": [
                "curl -i -X POST http://kong-admin:8001/services/petstore-api/routes --data 'paths[]=/petstore-api' --data 'strip_path=true'"
            ],
            "description": "Configure the route to match the Apigee base path '/petstore-api'",
            "estimated_time": "15 minutes",
            "priority": "critical",
            "step_number": 3,
            "title": "Create Kong Route with Base Path"
        },
        {
            "category": "Authentication",
            "code_snippets": {
                "setup_keyauth.sh": "#!/bin/bash\n# Configure key-auth plugin\ncurl -i -X POST http://kong-admin:8001/services/petstore-api/plugins \\\n  --data 'name=key-auth' \\\n  --data 'config.key_names=apikey' \\\n  --data 'config.key_in_query=true' \\\n  --data 'config.key_in_header=true' \\\n  --data 'config.hide_credentials=true'"
            },
            "commands": [
                "curl -i -X POST http://kong-admin:8001/services/petstore-api/plugins --data 'name=key-auth' --data 'config.key_names=apikey'"
            ],
            "description": "Set up Kong's key-auth plugin to replace Apigee's verify-api-key policy",
            "estimated_time": "20 minutes",
            "priority": "critical",
            "step_number": 4,
            "title": "Configure API Key Authentication"
        },
        {
            "category": "Authentication",
            "code_snippets": {
                "migrate_keys.sh": "#!/bin/bash\n# Script to migrate API keys from Apigee export\n# Replace with actual keys from Apigee export\nAPI_KEYS=('key1' 'key2' 'key3')\n\nfor i in \"${!API_KEYS[@]}\"; do\n  CONSUMER_NAME=\"petstore-client-$((i+1))\"\n  API_KEY=\"${API_KEYS[$i]}\"\n  \n  echo \"Creating consumer: $CONSUMER_NAME\"\n  curl -s -X POST http://kong-admin:8001/consumers \\\n    --data \"username=$CONSUMER_NAME\"\n  \n  echo \"Adding API key: $API_KEY\"\n  curl -s -X POST http://kong-admin:8001/consumers/$CONSUMER_NAME/key-auth \\\n    --data \"key=$API_KEY\"\ndone"
            },
            "commands": [
                "curl -i -X POST http://kong-admin:8001/consumers --data 'username=petstore-client-1'",
                "curl -i -X POST http://kong-admin:8001/consumers/petstore-client-1/key-auth --data 'key=your-existing-api-key'"
            ],
            "description": "Create Kong consumers and migrate existing API keys from Apigee",
            "estimated_time": "45 minutes",
            "priority": "high",
            "step_number": 5,
            "title": "Migrate API Keys and Create Consumers"
        },
        {
            "category": "Traffic Management",
            "code_snippets": {
                "setup_ratelimit.sh": "#!/bin/bash\ncurl -i -X POST http://kong-admin:8001/services/petstore-api/plugins \\\n  --data 'name=rate-limiting' \\\n  --data 'config.second=3' \\\n  --data 'config.minute=null' \\\n  --data 'config.hour=null' \\\n  --data 'config.day=null' \\\n  --data 'config.policy=local' \\\n  --data 'config.fault_tolerant=true' \\\n  --data 'config.hide_client_headers=false'"
            },
            "commands": [
                "curl -i -X POST http://kong-admin:8001/services/petstore-api/plugins --data 'name=rate-limiting' --data 'config.second=3' --data 'config.policy=local'"
            ],
            "description": "Set up Kong's rate-limiting plugin to replace Apigee's SA-SpikeArrest policy (3 requests per second)",
            "estimated_time": "20 minutes",
            "priority": "high",
            "step_number": 6,
            "title": "Configure Rate Limiting"
        },
        {
            "category": "Traffic Management",
            "code_snippets": {
                "setup_quota.sh": "#!/bin/bash\n# Additional rate limiting for quota (100 requests per minute)\ncurl -i -X POST http://kong-admin:8001/services/petstore-api/plugins \\\n  --data 'name=rate-limiting' \\\n  --data 'config.minute=100' \\\n  --data 'config.policy=local' \\\n  --data 'config.fault_tolerant=true'"
            },
            "commands": [
                "curl -i -X POST http://kong-admin:8001/services/petstore-api/plugins --data 'name=request-size-limiting' --data 'config.allowed_payload_size=1048576'"
            ],
            "description": "Set up request size limiting to replace Apigee's quota policy (100 requests per minute)",
            "estimated_time": "15 minutes",
            "priority": "high",
            "step_number": 7,
            "title": "Configure Request Size Limiting"
        },
        {
            "category": "Security",
            "code_snippets": {
                "json_protection.lua": "-- Custom JSON protection logic\nlocal json = require \"cjson\"\nlocal _M = {}\n\nfunction _M.validate_json_structure(body)\n  local success, decoded = pcall(json.decode, body)\n  if not success then\n    return false, \"Invalid JSON format\"\n  end\n  \n  -- Check array element count (max 20)\n  -- Check container depth (max 10)\n  -- Check object entry count (max 15)\n  -- Check string lengths (max 500)\n  \n  return true\nend\n\nreturn _M",
                "setup_validation.sh": "#!/bin/bash\n# Configure request validation\ncurl -i -X POST http://kong-admin:8001/services/petstore-api/plugins \\\n  --data 'name=request-validator' \\\n  --data 'config.body_schema={\"type\":\"object\",\"properties\":{},\"additionalProperties\":true}'"
            },
            "commands": [
                "curl -i -X POST http://kong-admin:8001/services/petstore-api/plugins --data 'name=request-validator'"
            ],
            "description": "Set up request validation to replace Apigee's JSON threat protection policies",
            "estimated_time": "30 minutes",
            "priority": "high",
            "step_number": 8,
            "title": "Configure Request Validation for JSON Protection"
        },
        {
            "category": "Security",
            "code_snippets": {
                "setup_sql_protection.sh": "#!/bin/bash\n# This would require a custom plugin implementation\n# For now, use request-termination with basic checks\necho \"Custom SQL injection protection plugin needed\"\necho \"Consider using Kong's request-transformer or custom plugin\"",
                "sql_injection_protection.lua": "-- SQL Injection Protection Plugin\nlocal _M = {}\n\nlocal SQL_PATTERNS = {\n  \"delete\", \"exec\", \"drop table\", \"insert\", \n  \"shutdown\", \"update\", \"or\", \"union\", \"select\"\n}\n\nfunction _M.check_sql_injection(query_params)\n  for param_name, param_value in pairs(query_params) do\n    local lower_value = string.lower(param_value)\n    for _, pattern in ipairs(SQL_PATTERNS) do\n      if string.find(lower_value, pattern, 1, true) then\n        return true, \"SQL injection pattern detected: \" .. pattern\n      end\n    end\n  end\n  return false\nend\n\nreturn _M"
            },
            "commands": [
                "curl -i -X POST http://kong-admin:8001/services/petstore-api/plugins --data 'name=request-termination'"
            ],
            "description": "Configure request termination plugin with custom logic to detect SQL injection patterns",
            "estimated_time": "45 minutes",
            "priority": "high",
            "step_number": 9,
            "title": "Implement SQL Injection Protection"
        },
        {
            "category": "Performance",
            "code_snippets": {
                "setup_cache.sh": "#!/bin/bash\ncurl -i -X POST http://kong-admin:8001/services/petstore-api/plugins \\\n  --data 'name=proxy-cache' \\\n  --data 'config.response_code=200' \\\n  --data 'config.request_method=GET' \\\n  --data 'config.content_type=application/json' \\\n  --data 'config.cache_ttl=300' \\\n  --data 'config.strategy=memory'"
            },
            "commands": [
                "curl -i -X POST http://kong-admin:8001/services/petstore-api/plugins --data 'name=proxy-cache' --data 'config.response_code=200' --data 'config.request_method=GET'"
            ],
            "description": "Set up Kong's proxy-cache plugin to replace Apigee's response cache policy",
            "estimated_time": "25 minutes",
            "priority": "medium",
            "step_number": 10,
            "title": "Configure Response Caching"
        },
        {
            "category": "Configuration",
            "code_snippets": {
                "setup_transformer.sh": "#!/bin/bash\ncurl -i -X POST http://kong-admin:8001/services/petstore-api/plugins \\\n  --data 'name=request-transformer' \\\n  --data 'config.remove.querystring=apikey' \\\n  --data 'config.remove.headers=apikey'"
            },
            "commands": [
                "curl -i -X POST http://kong-admin:8001/services/petstore-api/plugins --data 'name=request-transformer' --data 'config.remove.querystring=apikey'"
            ],
            "description": "Set up request transformer to remove API key from query parameters before forwarding to backend",
            "estimated_time": "20 minutes",
            "priority": "medium",
            "step_number": 11,
            "title": "Configure Request Transformation"
        },
        {
            "category": "Testing",
            "code_snippets": {
                "basic_tests.sh": "#!/bin/bash\nAPI_KEY=\"your-test-key\"\nBASE_URL=\"http://kong-gateway:8000/petstore-api\"\n\necho \"Testing GET /pets\"\ncurl -i \"$BASE_URL/pets?apikey=$API_KEY\"\n\necho \"\\nTesting POST /pets\"\ncurl -i -X POST \"$BASE_URL/pets?apikey=$API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"name\":\"test-pet\",\"status\":\"available\"}'\n\necho \"\\nTesting without API key (should fail)\"\ncurl -i \"$BASE_URL/pets\""
            },
            "commands": [
                "curl -i 'http://kong-gateway:8000/petstore-api/pets?apikey=your-test-key'",
                "curl -i -X POST 'http://kong-gateway:8000/petstore-api/pets?apikey=your-test-key' -H 'Content-Type: application/json' -d '{\"name\":\"test-pet\"}'"
            ],
            "description": "Test the migrated API to ensure basic functionality works correctly",
            "estimated_time": "30 minutes",
            "priority": "critical",
            "step_number": 12,
            "title": "Basic Functionality Testing"
        },
        {
            "category": "Security Testing",
            "code_snippets": {
                "security_tests.sh": "#!/bin/bash\nAPI_KEY=\"your-test-key\"\nBASE_URL=\"http://kong-gateway:8000/petstore-api\"\n\necho \"=== Security Tests ===\"\n\necho \"1. Testing without API key (should return 401)\"\ncurl -i \"$BASE_URL/pets\"\n\necho \"\\n2. Testing rate limiting (should block after 3 requests)\"\nfor i in {1..5}; do\n  echo \"Request $i:\"\n  curl -s -w \"Status: %{http_code}\\n\" \"$BASE_URL/pets?apikey=$API_KEY\"\n  sleep 0.1\ndone\n\necho \"\\n3. Testing SQL injection protection\"\ncurl -i \"$BASE_URL/pets?apikey=$API_KEY&search=test' OR '1'='1\"\n\necho \"\\n4. Testing large JSON payload\"\ncurl -i -X POST \"$BASE_URL/pets?apikey=$API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"name\":\"'$(printf 'a%.0s' {1..600})'\"}'"
            },
            "commands": [
                "curl -i 'http://kong-gateway:8000/petstore-api/pets'",
                "for i in {1..5}; do curl -s 'http://kong-gateway:8000/petstore-api/pets?apikey=your-test-key'; done"
            ],
            "description": "Test all security policies including API key authentication, rate limiting, and threat protection",
            "estimated_time": "45 minutes",
            "priority": "critical",
            "step_number": 13,
            "title": "Security Validation Testing"
        },
        {
            "category": "Performance Testing",
            "code_snippets": {
                "curl-format.txt": "     time_namelookup:  %{time_namelookup}\\n\n        time_connect:  %{time_connect}\\n\n     time_appconnect:  %{time_appconnect}\\n\n    time_pretransfer:  %{time_pretransfer}\\n\n       time_redirect:  %{time_redirect}\\n\n  time_starttransfer:  %{time_starttransfer}\\n\n                     ----------\\n\n          time_total:  %{time_total}\\n",
                "performance_tests.sh": "#!/bin/bash\nAPI_KEY=\"your-test-key\"\nBASE_URL=\"http://kong-gateway:8000/petstore-api\"\n\necho \"=== Performance Tests ===\"\n\necho \"1. Load testing with Apache Bench\"\nab -n 1000 -c 10 \"$BASE_URL/pets?apikey=$API_KEY\"\n\necho \"\\n2. Response time testing\"\nfor i in {1..10}; do\n  curl -w \"Response time: %{time_total}s\\n\" -s -o /dev/null \"$BASE_URL/pets?apikey=$API_KEY\"\ndone\n\necho \"\\n3. Cache testing (second request should be faster)\"\ncurl -w \"First request: %{time_total}s\\n\" -s -o /dev/null \"$BASE_URL/pets?apikey=$API_KEY\"\ncurl -w \"Cached request: %{time_total}s\\n\" -s -o /dev/null \"$BASE_URL/pets?apikey=$API_KEY\""
            },
            "commands": [
                "ab -n 1000 -c 10 'http://kong-gateway:8000/petstore-api/pets?apikey=your-test-key'",
                "curl -w '@curl-format.txt' -s 'http://kong-gateway:8000/petstore-api/pets?apikey=your-test-key'"
            ],
            "description": "Validate that performance characteristics match or exceed Apigee implementation",
            "estimated_time": "60 minutes",
            "priority": "high",
            "step_number": 14,
            "title": "Performance and Load Testing"
        },
        {
            "category": "Monitoring",
            "code_snippets": {
                "setup_monitoring.sh": "#!/bin/bash\necho \"Setting up monitoring plugins\"\n\n# Prometheus metrics\ncurl -i -X POST http://kong-admin:8001/services/petstore-api/plugins \\\n  --data 'name=prometheus'\n\n# File logging\ncurl -i -X POST http://kong-admin:8001/services/petstore-api/plugins \\\n  --data 'name=file-log' \\\n  --data 'config.path=/tmp/kong-petstore.log'\n\n# HTTP logging (optional - for external log aggregation)\ncurl -i -X POST http://kong-admin:8001/services/petstore-api/plugins \\\n  --data 'name=http-log' \\\n  --data 'config.http_endpoint=http://your-log-collector:8080/logs'"
            },
            "commands": [
                "curl -i -X POST http://kong-admin:8001/services/petstore-api/plugins --data 'name=prometheus'",
                "curl -i -X POST http://kong-admin:8001/services/petstore-api/plugins --data 'name=file-log'"
            ],
            "description": "Set up monitoring and logging to match Apigee's observability features",
            "estimated_time": "40 minutes",
            "priority": "medium",
            "step_number": 15,
            "title": "Configure Monitoring and Logging"
        },
        {
            "category": "Rollback Preparation",
            "code_snippets": {
                "rollback_script.sh": "#!/bin/bash\necho \"=== Kong Rollback Script ===\"\necho \"This script will remove all petstore-api configurations\"\n\nread -p \"Are you sure you want to rollback? (y/N): \" confirm\nif [[ $confirm != [yY] ]]; then\n  echo \"Rollback cancelled\"\n  exit 0\nfi\n\necho \"Removing plugins...\"\ncurl -X DELETE http://kong-admin:8001/services/petstore-api/plugins\n\necho \"Removing routes...\"\ncurl -X DELETE http://kong-admin:8001/routes/petstore-api-route\n\necho \"Removing service...\"\ncurl -X DELETE http://kong-admin:8001/services/petstore-api\n\necho \"Removing consumers...\"\nfor consumer in petstore-client-1 petstore-client-2 petstore-client-3; do\n  curl -X DELETE http://kong-admin:8001/consumers/$consumer\ndone\n\necho \"Rollback completed\"",
                "validation_script.sh": "#!/bin/bash\necho \"=== Post-Migration Validation ===\"\n\n# Check service exists\nSERVICE_CHECK=$(curl -s http://kong-admin:8001/services/petstore-api | jq -r '.name')\nif [ \"$SERVICE_CHECK\" = \"petstore-api\" ]; then\n  echo \"\u2713 Service created successfully\"\nelse\n  echo \"\u2717 Service creation failed\"\nfi\n\n# Check plugins are active\nPLUGIN_COUNT=$(curl -s http://kong-admin:8001/services/petstore-api/plugins | jq '.data | length')\necho \"\u2713 $PLUGIN_COUNT plugins configured\"\n\n# Test API endpoint\nAPI_TEST=$(curl -s -w \"%{http_code}\" http://kong-gateway:8000/petstore-api/pets?apikey=test-key)\nif [[ $API_TEST == *\"200\"* ]]; then\n  echo \"\u2713 API endpoint responding correctly\"\nelse\n  echo \"\u2717 API endpoint test failed\"\nfi"
            },
            "commands": [
                "kong config db_export kong_post_migration_backup.yaml",
                "kubectl get services,routes,plugins -o yaml > kong_migration_complete.yaml"
            ],
            "description": "Document rollback procedures and create rollback scripts in case migration needs to be reverted",
            "estimated_time": "30 minutes",
            "priority": "high",
            "step_number": 16,
            "title": "Prepare Rollback Strategy"
        }
    ],
    "migration_report": "# Apigee to Kong Migration Report: petstore-api\n\n## Executive Summary\n\nThis report outlines the migration strategy for the **petstore-api** proxy from Apigee to Kong Gateway. The API serves as a comprehensive pet store service with advanced security, rate limiting, caching, and mediation capabilities.\n\n### Key Migration Metrics\n- **Total Policies**: 9\n- **Auto-migrated**: 7 (78.0%)\n- **Bundled Policies**: 7\n- **Custom Plugins Required**: 0\n- **Current Validation Status**: \u274c Invalid (9 errors, 14 warnings)\n- **Manual Steps Required**: 16\n\n### Migration Complexity: **MEDIUM-HIGH**\nThe migration presents moderate complexity due to validation errors and the need for extensive manual configuration, despite high auto-migration coverage.\n\n---\n\n## Migration Coverage Analysis\n\n### Policy Mapping Details\n\n| Apigee Policy | Kong Plugin | Migration Status | Notes |\n|---------------|-------------|------------------|-------|\n| SA-SpikeArrest | rate-limiting | \u2705 Auto-migrated | Rate: 3 requests/second |\n| verify-api-key | key-auth | \u2705 Auto-migrated | Query parameter source |\n| remove-query-param-apikey | request-transformer | \u2705 Auto-migrated | Remove apikey param |\n| Security-JSONProtection | Custom Logic | \u26a0\ufe0f Manual Required | JSON structure validation |\n| impose-quota | rate-limiting-advanced | \u2705 Auto-migrated | Monthly quota limits |\n| ResponseCache | proxy-cache | \u2705 Auto-migrated | 300s TTL |\n| add-cors | cors | \u2705 Auto-migrated | CORS headers |\n| AssignMessage-SetHeaders | request-transformer | \u2705 Auto-migrated | Custom headers |\n| JavaScript-Transform | serverless-functions | \u26a0\ufe0f Manual Required | Custom transformation |\n\n### Bundling Optimization\n\n**Current Bundling Efficiency: 0.0%** - Significant optimization opportunity exists.\n\n#### Recommended Plugin Bundles:\n\n1. **Authentication Bundle**\n   ```yaml\n   plugins:\n   - name: key-auth\n     config:\n       key_names: [\"apikey\"]\n       key_in_query: true\n   - name: request-transformer\n     config:\n       remove:\n         querystring: [\"apikey\"]\n   ```\n\n2. **Rate Limiting Bundle**\n   ```yaml\n   plugins:\n   - name: rate-limiting\n     config:\n       second: 3\n       policy: redis\n   - name: rate-limiting-advanced\n     config:\n       limit: [1000]\n       window_size: [2592000]  # 30 days\n   ```\n\n---\n\n## Breaking Changes & Impact\n\n### Critical Breaking Changes\n\n1. **JSON Protection Policy**\n   - **Impact**: Custom JSON validation logic not directly supported\n   - **Mitigation**: Implement using Kong's request-validator plugin or custom Lua script\n\n2. **JavaScript Transformation**\n   - **Impact**: Custom JavaScript logic requires conversion\n   - **Mitigation**: Rewrite as Lua script or use serverless functions\n\n3. **Spike Arrest Identifier**\n   - **Impact**: Per-API-key rate limiting may behave differently\n   - **Mitigation**: Configure rate-limiting plugin with consumer-based limits\n\n### Configuration Changes Required\n\n```yaml\n# Kong Service Configuration\nservices:\n- name: petstore-api\n  url: http://petstore.swagger.io/v1\n  \nroutes:\n- name: petstore-route\n  service: petstore-api\n  paths: [\"/petstore-api\"]\n```\n\n---\n\n## Manual Migration Steps (Critical First)\n\n### Phase 1: Critical Security & Validation (Priority 1)\n\n1. **Fix JSON Protection Implementation**\n   ```lua\n   -- Custom Lua script for JSON validation\n   local json = require \"cjson\"\n   \n   local function validate_json_structure(body)\n     local data = json.decode(body)\n     -- Implement array_element_count: 20\n     -- Implement container_depth: 10  \n     -- Implement object_entry_count: 15\n     return true\n   end\n   ```\n\n2. **Implement JavaScript Transformation Logic**\n   ```yaml\n   plugins:\n   - name: serverless-functions\n     config:\n       functions:\n       - |\n         return function(kong)\n           -- Convert Apigee JavaScript logic to Lua\n           local request_body = kong.request.get_raw_body()\n           -- Apply transformations\n           kong.service.request.set_raw_body(transformed_body)\n         end\n   ```\n\n### Phase 2: Configuration Validation (Priority 2)\n\n3. **Resolve Rate Limiting Configuration**\n   ```yaml\n   plugins:\n   - name: rate-limiting\n     config:\n       second: 3\n       minute: 180\n       hour: 10800\n       policy: redis\n       redis_host: \"redis-cluster\"\n       fault_tolerant: true\n   ```\n\n4. **Configure Response Caching**\n   ```yaml\n   plugins:\n   - name: proxy-cache\n     config:\n       response_code: [200, 301, 404]\n       request_method: [\"GET\", \"HEAD\"]\n       content_type: [\"application/json\"]\n       cache_ttl: 300\n       strategy: memory\n   ```\n\n### Phase 3: Headers & CORS (Priority 3)\n\n5. **Implement Custom Headers**\n   ```yaml\n   plugins:\n   - name: request-transformer\n     config:\n       add:\n         headers:\n         - \"X-Forwarded-Proto: https\"\n         - \"X-Request-ID: $(uuid)\"\n   ```\n\n6. **Configure CORS Policy**\n   ```yaml\n   plugins:\n   - name: cors\n     config:\n       origins: [\"*\"]\n       methods: [\"GET\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\"]\n       headers: [\"Accept\", \"Content-Type\", \"Authorization\"]\n       exposed_headers: [\"X-Auth-Token\"]\n       credentials: true\n       max_age: 3600\n   ```\n\n---\n\n## Testing Strategy\n\n### Pre-Migration Testing\n\n1. **Baseline Performance Testing**\n   ```bash\n   # Load test current Apigee endpoint\n   k6 run --vus 50 --duration 5m apigee-baseline-test.js\n   ```\n\n2. **Security Validation**\n   ```bash\n   # Test API key authentication\n   curl -X GET \"https://api.company.com/petstore-api/pets?apikey=invalid\" \\\n        -H \"Accept: application/json\"\n   # Expected: 401 Unauthorized\n   ```\n\n### Post-Migration Testing\n\n1. **Functional Testing Suite**\n   ```yaml\n   # Kong Gateway Tests\n   tests:\n     - name: \"API Key Authentication\"\n       request:\n         method: GET\n         url: \"/petstore-api/pets\"\n         headers:\n           apikey: \"valid-key-123\"\n       expect:\n         status: 200\n   \n     - name: \"Rate Limiting\"\n       request:\n         method: GET\n         url: \"/petstore-api/pets\"\n         repeat: 5\n         interval: 200ms\n       expect:\n         status: [200, 429]\n   ```\n\n2. **Performance Comparison**\n   ```bash\n   # Compare response times\n   kong-performance-test.sh --baseline apigee-results.json\n   ```\n\n---\n\n## Deployment Plan\n\n### Phase 1: Infrastructure Setup (Week 1)\n- Deploy Kong Gateway cluster\n- Configure Redis for rate limiting\n- Set up monitoring and logging\n\n### Phase 2: Configuration Migration (Week 2)\n```bash\n# Deploy Kong configuration\ndeck sync --kong-addr http://kong-admin:8001 --state kong-config.yaml\n\n# Validate configuration\ndeck validate --kong-addr http://kong-admin:8001\n```\n\n### Phase 3: Traffic Migration (Week 3)\n```yaml\n# Blue-Green Deployment Strategy\nupstream_apigee:\n  weight: 100\nupstream_kong:\n  weight: 0\n\n# Gradual traffic shift\n# Day 1: 90% Apigee, 10% Kong\n# Day 3: 70% Apigee, 30% Kong  \n# Day 5: 50% Apigee, 50% Kong\n# Day 7: 0% Apigee, 100% Kong\n```\n\n---\n\n## Rollback Procedure\n\n### Immediate Rollback (< 5 minutes)\n```bash\n# Emergency rollback script\n#!/bin/bash\necho \"Initiating emergency rollback...\"\n\n# Switch traffic back to Apigee\nkubectl patch service petstore-api -p '{\"spec\":{\"selector\":{\"app\":\"apigee-proxy\"}}}'\n\n# Verify rollback\ncurl -f https://api.company.com/petstore-api/health || exit 1\necho \"Rollback completed successfully\"\n```\n\n### Gradual Rollback (Planned)\n1. Reduce Kong traffic to 0%\n2. Monitor for 15 minutes\n3. Disable Kong plugins\n4. Archive Kong configuration\n\n---\n\n## Risk Assessment\n\n| Risk Category | Probability | Impact | Mitigation Strategy |\n|---------------|-------------|--------|-------------------|\n| **Validation Errors** | High | High | Comprehensive pre-migration testing |\n| **Performance Degradation** | Medium | High | Load testing and gradual rollout |\n| **Security Gaps** | Low | Critical | Security audit and penetration testing |\n| **Data Loss** | Low | Medium | Backup all configurations |\n| **Downtime** | Medium | High | Blue-green deployment strategy |\n\n### Critical Risk Factors\n- **9 validation errors** require immediate attention\n- **Custom JavaScript logic** needs careful conversion\n- **JSON protection** implementation complexity\n\n---\n\n## Timeline Estimate\n\n### Detailed Schedule\n\n| Phase | Duration | Key Activities | Dependencies |\n|-------|----------|----------------|--------------|\n| **Preparation** | 1 week | Environment setup, tooling | Infrastructure team |\n| **Development** | 2 weeks | Policy conversion, testing | Development team |\n| **Testing** | 1 week | Integration and performance testing | QA team |\n| **Deployment** | 1 week | Gradual traffic migration | Operations team |\n| **Validation** | 3 days | Post-migration validation | All teams |\n\n**Total Estimated Duration: 5.5 weeks**\n\n### Critical Path Items\n1. Resolve validation errors (Week 1)\n2. Implement custom JavaScript logic (Week 2)\n3. Performance testing (Week 4)\n4. Production deployment (Week 5)\n\n---\n\n## Success Criteria\n\n### Technical Metrics\n- \u2705 **Zero validation errors** in Kong configuration\n- \u2705 **Response time < 200ms** (95th percentile)\n- \u2705 **Uptime > 99.9%** during migration\n- \u2705 **All security policies** functioning correctly\n\n### Business Metrics\n- \u2705 **Zero API functionality regression**\n- \u2705 **No increase in error rates**\n- \u2705 **Successful authentication** for all valid API keys\n- \u2705 **Rate limiting** working as expected\n\n### Validation Checklist\n```bash\n# Post-migration validation script\n#!/bin/bash\n\necho \"Running post-migration validation...\"\n\n# Test API functionality\ntest_api_endpoints() {\n  curl -f \"https://api.company.com/petstore-api/pets?apikey=test-key\" || return 1\n  curl -f \"https://api.company.com/petstore-api/pets/1?apikey=test-key\" || return 1\n}\n\n# Test rate limiting\ntest_rate_limiting() {\n  for i in {1..5}; do\n    curl -w \"%{http_code}\\n\" \"https://api.company.com/petstore-api/pets?apikey=test-key\"\n  done | grep -q \"429\" || return 1\n}\n\n# Test security\ntest_security() {\n  curl -w \"%{http_code}\\n\" \"https://api.company.com/petstore-api/pets\" | grep -q \"401\" || return 1\n}\n\ntest_api_endpoints && test_rate_limiting && test_security\necho \"All validation tests passed \u2705\"\n```\n\n---\n\n**Migration Report Generated**: `date +\"%Y-%m-%d %H:%M:%S\"`  \n**Report Version**: 1.0  \n**Next Review Date**: 2 weeks post-deployment",
    "test_scripts": "```bash\n#!/bin/bash\n\n# =============================================================================\n# Kong API Migration Test Suite - Petstore API\n# Tests migrated from Apigee to Kong Gateway\n# =============================================================================\n\nset -e  # Exit on any error\n\n# Configuration\nKONG_ADMIN_URL=\"${KONG_ADMIN_URL:-http://localhost:8001}\"\nKONG_PROXY_URL=\"${KONG_PROXY_URL:-http://localhost:8000}\"\nSERVICE_NAME=\"petstore-api\"\nROUTE_PATH=\"/petstore-api\"\nTEST_API_KEY=\"\"\nCONSUMER_NAME=\"test-consumer\"\nRESULTS_FILE=\"kong_migration_test_results.log\"\n\n# Colors for output\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m' # No Color\n\n# Test counters\nTOTAL_TESTS=0\nPASSED_TESTS=0\nFAILED_TESTS=0\n\n# =============================================================================\n# Utility Functions\n# =============================================================================\n\nlog() {\n    echo -e \"${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1\" | tee -a \"$RESULTS_FILE\"\n}\n\nsuccess() {\n    echo -e \"${GREEN}\u2713 PASS:${NC} $1\" | tee -a \"$RESULTS_FILE\"\n    ((PASSED_TESTS++))\n}\n\nfail() {\n    echo -e \"${RED}\u2717 FAIL:${NC} $1\" | tee -a \"$RESULTS_FILE\"\n    ((FAILED_TESTS++))\n}\n\nwarning() {\n    echo -e \"${YELLOW}\u26a0 WARNING:${NC} $1\" | tee -a \"$RESULTS_FILE\"\n}\n\nrun_test() {\n    ((TOTAL_TESTS++))\n    log \"Running test: $1\"\n}\n\nassert_http_code() {\n    local expected=$1\n    local actual=$2\n    local test_name=$3\n    \n    if [ \"$actual\" = \"$expected\" ]; then\n        success \"$test_name - HTTP $actual\"\n    else\n        fail \"$test_name - Expected HTTP $expected, got $actual\"\n    fi\n}\n\nassert_contains() {\n    local haystack=$1\n    local needle=$2\n    local test_name=$3\n    \n    if echo \"$haystack\" | grep -q \"$needle\"; then\n        success \"$test_name - Contains '$needle'\"\n    else\n        fail \"$test_name - Does not contain '$needle'\"\n    fi\n}\n\nassert_not_contains() {\n    local haystack=$1\n    local needle=$2\n    local test_name=$3\n    \n    if ! echo \"$haystack\" | grep -q \"$needle\"; then\n        success \"$test_name - Does not contain '$needle'\"\n    else\n        fail \"$test_name - Unexpectedly contains '$needle'\"\n    fi\n}\n\nwait_for_kong() {\n    log \"Waiting for Kong to be ready...\"\n    local max_attempts=30\n    local attempt=1\n    \n    while [ $attempt -le $max_attempts ]; do\n        if curl -s \"$KONG_ADMIN_URL/status\" > /dev/null 2>&1; then\n            success \"Kong is ready\"\n            return 0\n        fi\n        log \"Attempt $attempt/$max_attempts - Kong not ready, waiting...\"\n        sleep 2\n        ((attempt++))\n    done\n    \n    fail \"Kong failed to start within timeout\"\n    exit 1\n}\n\n# =============================================================================\n# Setup Functions\n# =============================================================================\n\nsetup_test_environment() {\n    log \"Setting up test environment...\"\n    \n    # Initialize results file\n    echo \"Kong Migration Test Results - $(date)\" > \"$RESULTS_FILE\"\n    echo \"========================================\" >> \"$RESULTS_FILE\"\n    \n    # Wait for Kong to be ready\n    wait_for_kong\n    \n    # Create consumer for testing\n    log \"Creating test consumer...\"\n    curl -s -X POST \"$KONG_ADMIN_URL/consumers\" \\\n        -d \"username=$CONSUMER_NAME\" \\\n        -d \"custom_id=test-user-001\" > /dev/null || true\n    \n    # Create API key for consumer\n    log \"Creating API key for consumer...\"\n    local key_response=$(curl -s -X POST \"$KONG_ADMIN_URL/consumers/$CONSUMER_NAME/key-auth\" \\\n        -d \"key=test-api-key-12345\")\n    \n    TEST_API_KEY=$(echo \"$key_response\" | grep -o '\"key\":\"[^\"]*\"' | cut -d'\"' -f4)\n    \n    if [ -z \"$TEST_API_KEY\" ]; then\n        TEST_API_KEY=\"test-api-key-12345\"\n    fi\n    \n    log \"Test API Key: $TEST_API_KEY\"\n    \n    # Wait for configuration to propagate\n    sleep 2\n    \n    success \"Test environment setup complete\"\n}\n\n# =============================================================================\n# Authentication Tests\n# =============================================================================\n\ntest_authentication() {\n    log \"=== AUTHENTICATION TESTS ===\"\n    \n    # Test 1: Request without API key should fail\n    run_test \"Authentication - No API key\"\n    response=$(curl -s -w \"%{http_code}\" -o /tmp/kong_test_response \"$KONG_PROXY_URL$ROUTE_PATH/pets\")\n    http_code=\"${response: -3}\"\n    assert_http_code \"401\" \"$http_code\" \"No API key authentication\"\n    \n    # Test 2: Request with invalid API key should fail\n    run_test \"Authentication - Invalid API key\"\n    response=$(curl -s -w \"%{http_code}\" -o /tmp/kong_test_response \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=invalid-key\")\n    http_code=\"${response: -3}\"\n    assert_http_code \"401\" \"$http_code\" \"Invalid API key authentication\"\n    \n    # Test 3: Request with valid API key should succeed\n    run_test \"Authentication - Valid API key\"\n    response=$(curl -s -w \"%{http_code}\" -o /tmp/kong_test_response \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY\")\n    http_code=\"${response: -3}\"\n    # Note: May return 404 if backend is not available, but should not be 401\n    if [ \"$http_code\" != \"401\" ] && [ \"$http_code\" != \"403\" ]; then\n        success \"Valid API key authentication - HTTP $http_code\"\n    else\n        fail \"Valid API key authentication - HTTP $http_code\"\n    fi\n    \n    # Test 4: Verify API key is removed from backend request (hide_credentials)\n    run_test \"Authentication - API key removal\"\n    # This test would require backend logging to verify, so we'll test the configuration\n    config_response=$(curl -s \"$KONG_ADMIN_URL/services/$SERVICE_NAME/plugins\" | grep -o '\"hide_credentials\":true')\n    if [ -n \"$config_response\" ]; then\n        success \"API key removal configuration verified\"\n    else\n        fail \"API key removal configuration not found\"\n    fi\n}\n\n# =============================================================================\n# Rate Limiting Tests\n# =============================================================================\n\ntest_rate_limiting() {\n    log \"=== RATE LIMITING TESTS ===\"\n    \n    # Test 1: Verify rate limiting headers are present\n    run_test \"Rate Limiting - Headers present\"\n    response=$(curl -s -I \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY\")\n    assert_contains \"$response\" \"X-RateLimit-Remaining\" \"Rate limit headers\"\n    \n    # Test 2: Test spike arrest (3 requests per second)\n    run_test \"Rate Limiting - Spike arrest enforcement\"\n    local success_count=0\n    local rate_limited_count=0\n    \n    # Send 5 rapid requests\n    for i in {1..5}; do\n        response=$(curl -s -w \"%{http_code}\" -o /dev/null \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY\")\n        http_code=\"${response: -3}\"\n        \n        if [ \"$http_code\" = \"429\" ]; then\n            ((rate_limited_count++))\n        elif [ \"$http_code\" != \"401\" ] && [ \"$http_code\" != \"403\" ]; then\n            ((success_count++))\n        fi\n        \n        # Small delay to avoid overwhelming\n        sleep 0.1\n    done\n    \n    if [ $rate_limited_count -gt 0 ]; then\n        success \"Spike arrest working - $rate_limited_count requests rate limited\"\n    else\n        warning \"Spike arrest may not be working - no rate limiting detected\"\n    fi\n    \n    # Test 3: Verify rate limit reset after window\n    run_test \"Rate Limiting - Rate limit reset\"\n    sleep 2  # Wait for rate limit window to reset\n    response=$(curl -s -w \"%{http_code}\" -o /tmp/kong_test_response \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY\")\n    http_code=\"${response: -3}\"\n    \n    if [ \"$http_code\" != \"429\" ]; then\n        success \"Rate limit reset after window - HTTP $http_code\"\n    else\n        fail \"Rate limit did not reset - HTTP $http_code\"\n    fi\n}\n\n# =============================================================================\n# CORS Tests\n# =============================================================================\n\ntest_cors() {\n    log \"=== CORS TESTS ===\"\n    \n    # Test 1: Preflight OPTIONS request\n    run_test \"CORS - Preflight request\"\n    response=$(curl -s -X OPTIONS \\\n        -H \"Origin: https://example.com\" \\\n        -H \"Access-Control-Request-Method: GET\" \\\n        -H \"Access-Control-Request-Headers: Content-Type\" \\\n        -w \"%{http_code}\" \\\n        -o /tmp/kong_test_response \\\n        \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY\")\n    \n    http_code=\"${response: -3}\"\n    headers=$(curl -s -X OPTIONS \\\n        -H \"Origin: https://example.com\" \\\n        -H \"Access-Control-Request-Method: GET\" \\\n        -H \"Access-Control-Request-Headers: Content-Type\" \\\n        -I \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY\")\n    \n    # Check for CORS headers (if CORS plugin is configured)\n    if echo \"$headers\" | grep -q \"Access-Control-Allow-Origin\"; then\n        success \"CORS preflight handling\"\n        assert_contains \"$headers\" \"Access-Control-Allow-Origin\" \"CORS Allow-Origin header\"\n        assert_contains \"$headers\" \"Access-Control-Allow-Methods\" \"CORS Allow-Methods header\"\n    else\n        warning \"CORS plugin may not be configured\"\n    fi\n    \n    # Test 2: Actual CORS request\n    run_test \"CORS - Actual request with Origin\"\n    headers=$(curl -s -H \"Origin: https://example.com\" \\\n        -I \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY\")\n    \n    if echo \"$headers\" | grep -q \"Access-Control-Allow-Origin\"; then\n        success \"CORS actual request handling\"\n    else\n        warning \"CORS headers not present in actual request\"\n    fi\n}\n\n# =============================================================================\n# Request/Response Transformation Tests\n# =============================================================================\n\ntest_transformations() {\n    log \"=== REQUEST/RESPONSE TRANSFORMATION TESTS ===\"\n    \n    # Test 1: Verify API key is removed from query parameters\n    run_test \"Transformation - API key removal from query\"\n    # This would require backend inspection, so we test the configuration\n    plugin_config=$(curl -s \"$KONG_ADMIN_URL/services/$SERVICE_NAME/plugins\" | grep -o '\"hide_credentials\":true')\n    if [ -n \"$plugin_config\" ]; then\n        success \"API key removal transformation configured\"\n    else\n        fail \"API key removal transformation not configured\"\n    fi\n    \n    # Test 2: Test JSON payload handling (if applicable)\n    run_test \"Transformation - JSON payload handling\"\n    json_payload='{\"name\":\"test-pet\",\"status\":\"available\"}'\n    response=$(curl -s -X POST \\\n        -H \"Content-Type: application/json\" \\\n        -d \"$json_payload\" \\\n        -w \"%{http_code}\" \\\n        -o /tmp/kong_test_response \\\n        \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY\")\n    \n    http_code=\"${response: -3}\"\n    if [ \"$http_code\" != \"401\" ] && [ \"$http_code\" != \"403\" ]; then\n        success \"JSON payload transformation - HTTP $http_code\"\n    else\n        fail \"JSON payload transformation failed - HTTP $http_code\"\n    fi\n    \n    # Test 3: Verify response headers are properly set\n    run_test \"Transformation - Response headers\"\n    headers=$(curl -s -I \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY\")\n    \n    # Check for Kong-specific headers\n    if echo \"$headers\" | grep -q \"Via:\"; then\n        success \"Kong proxy headers present\"\n    else\n        warning \"Kong proxy headers not detected\"\n    fi\n}\n\n# =============================================================================\n# Error Handling Tests\n# =============================================================================\n\ntest_error_handling() {\n    log \"=== ERROR HANDLING TESTS ===\"\n    \n    # Test 1: 401 Unauthorized for missing API key\n    run_test \"Error Handling - 401 Unauthorized\"\n    response=$(curl -s -w \"%{http_code}\" -o /tmp/kong_test_response \"$KONG_PROXY_URL$ROUTE_PATH/pets\")\n    http_code=\"${response: -3}\"\n    assert_http_code \"401\" \"$http_code\" \"Missing API key error\"\n    \n    # Test 2: 429 Too Many Requests for rate limiting\n    run_test \"Error Handling - 429 Rate Limited\"\n    # Send multiple rapid requests to trigger rate limiting\n    for i in {1..10}; do\n        response=$(curl -s -w \"%{http_code}\" -o /tmp/kong_test_response \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY\")\n        http_code=\"${response: -3}\"\n        if [ \"$http_code\" = \"429\" ]; then\n            success \"Rate limiting error handling - HTTP 429\"\n            break\n        fi\n        sleep 0.05\n    done\n    \n    # Test 3: 404 Not Found for invalid endpoints\n    run_test \"Error Handling - 404 Not Found\"\n    response=$(curl -s -w \"%{http_code}\" -o /tmp/kong_test_response \"$KONG_PROXY_URL/invalid-endpoint?apikey=$TEST_API_KEY\")\n    http_code=\"${response: -3}\"\n    assert_http_code \"404\" \"$http_code\" \"Invalid endpoint error\"\n    \n    # Test 4: Verify error response format\n    run_test \"Error Handling - Error response format\"\n    error_response=$(curl -s \"$KONG_PROXY_URL$ROUTE_PATH/pets\")\n    \n    if echo \"$error_response\" | grep -q \"message\"; then\n        success \"Error response contains message field\"\n    else\n        warning \"Error response format may not include message field\"\n    fi\n}\n\n# =============================================================================\n# Performance Tests\n# =============================================================================\n\ntest_performance() {\n    log \"=== PERFORMANCE TESTS ===\"\n    \n    # Test 1: Basic latency test\n    run_test \"Performance - Basic latency\"\n    start_time=$(date +%s%N)\n    response=$(curl -s -w \"%{http_code}\" -o /dev/null \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY\")\n    end_time=$(date +%s%N)\n    \n    latency=$(( (end_time - start_time) / 1000000 ))  # Convert to milliseconds\n    log \"Request latency: ${latency}ms\"\n    \n    if [ $latency -lt 1000 ]; then  # Less than 1 second\n        success \"Basic latency acceptable (${latency}ms)\"\n    else\n        warning \"High latency detected (${latency}ms)\"\n    fi\n    \n    # Test 2: Concurrent requests test\n    run_test \"Performance - Concurrent requests\"\n    log \"Running 10 concurrent requests...\"\n    \n    # Create temporary file for results\n    temp_results=\"/tmp/kong_concurrent_test_$$\"\n    \n    # Run concurrent requests\n    for i in {1..10}; do\n        (\n            response=$(curl -s -w \"%{http_code}:%{time_total}\" -o /dev/null \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY\")\n            echo \"$response\" >> \"$temp_results\"\n        ) &\n    done\n    \n    # Wait for all background jobs to complete\n    wait\n    \n    # Analyze results\n    if [ -f \"$temp_results\" ]; then\n        total_requests=$(wc -l < \"$temp_results\")\n        successful_requests=$(grep -c \"^[2-3][0-9][0-9]:\" \"$temp_results\" || echo \"0\")\n        \n        log \"Concurrent test results: $successful_requests/$total_requests successful\"\n        \n        if [ $successful_requests -ge 8 ]; then  # At least 80% success rate\n            success \"Concurrent requests handling ($successful_requests/$total_requests)\"\n        else\n            fail \"Poor concurrent request performance ($successful_requests/$total_requests)\"\n        fi\n        \n        # Calculate average response time\n        if [ $successful_requests -gt 0 ]; then\n            avg_time=$(grep \"^[2-3][0-9][0-9]:\" \"$temp_results\" | cut -d':' -f2 | awk '{sum+=$1} END {print sum/NR}')\n            log \"Average response time: ${avg_time}s\"\n        fi\n        \n        rm -f \"$temp_results\"\n    else\n        fail \"Concurrent test results file not created\"\n    fi\n    \n    # Test 3: Memory usage check (Kong admin API)\n    run_test \"Performance - Memory usage check\"\n    status_response=$(curl -s \"$KONG_ADMIN_URL/status\")\n    \n    if echo \"$status_response\" | grep -q \"memory\"; then\n        success \"Kong status endpoint accessible\"\n        log \"Kong status: $status_response\"\n    else\n        warning \"Kong status endpoint may not be available\"\n    fi\n}\n\n# =============================================================================\n# Security Tests\n# =============================================================================\n\ntest_security() {\n    log \"=== SECURITY TESTS ===\"\n    \n    # Test 1: SQL Injection attempt\n    run_test \"Security - SQL Injection protection\"\n    malicious_payload=\"'; DROP TABLE pets; --\"\n    response=$(curl -s -w \"%{http_code}\" -o /tmp/kong_test_response \\\n        \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY&id=$malicious_payload\")\n    http_code=\"${response: -3}\"\n    \n    # Should not return 500 (internal server error)\n    if [ \"$http_code\" != \"500\" ]; then\n        success \"SQL injection protection - HTTP $http_code\"\n    else\n        fail \"Potential SQL injection vulnerability - HTTP $http_code\"\n    fi\n    \n    # Test 2: XSS attempt\n    run_test \"Security - XSS protection\"\n    xss_payload=\"<script>alert('xss')</script>\"\n    response=$(curl -s -w \"%{http_code}\" -o /tmp/kong_test_response \\\n        \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY&name=$xss_payload\")\n    http_code=\"${response: -3}\"\n    \n    if [ \"$http_code\" != \"500\" ]; then\n        success \"XSS protection - HTTP $http_code\"\n    else\n        fail \"Potential XSS vulnerability - HTTP $http_code\"\n    fi\n    \n    # Test 3: Large payload test (JSON bomb protection)\n    run_test \"Security - Large payload protection\"\n    large_payload=$(printf '{\"data\":\"%*s\"}' 10000 \"\")\n    response=$(curl -s -X POST \\\n        -H \"Content-Type: application/json\" \\\n        -d \"$large_payload\" \\\n        -w \"%{http_code}\" \\\n        -o /tmp/kong_test_response \\\n        \"$KONG_PROXY_URL$ROUTE_PATH/pets?apikey=$TEST_API_KEY\")\n    \n    http_code=\"${response: -3}\"\n    log \"Large payload test result: HTTP $http_code\"\n    \n    # Should handle large payloads gracefully (not crash)\n    if [ \"$http_code\" != \"500\" ]; then\n        success \"Large payload handling - HTTP $http_code\"\n    else\n        warning \"Large payload may cause issues - HTTP $http_code\"\n    fi\n}\n\n# =============================================================================\n# Configuration Validation Tests\n# =============================================================================\n\ntest_configuration() {\n    log \"=== CONFIGURATION VALIDATION TESTS ===\"\n    \n    # Test 1: Verify service configuration\n    run_test \"Configuration - Service setup\"\n    service_config=$(curl -s \"$KONG_ADMIN_URL/services/$SERVICE_NAME\")\n    \n    if echo \"$service_config\" | grep -q \"petstore-api\"; then\n        success \"Service configuration verified\"\n    else\n        fail \"Service configuration not found\"\n    fi\n    \n    # Test 2: Verify plugins are configured\n    run_test \"Configuration - Plugins setup\"\n    plugins_config=$(curl -s \"$KONG_ADMIN_URL/services/$SERVICE_NAME/plugins\")\n    \n    if echo \"$plugins_config\" | grep -q \"key-auth\"; then\n        success \"Key authentication plugin configured\"\n    else\n        fail \"Key authentication plugin not found\"\n    fi\n    \n    if echo \"$plugins_config\" | grep -q \"rate-limiting\"; then\n        success \"Rate limiting plugin configured\"\n    else\n        warning \"Rate limiting plugin not found\"\n    fi\n    \n    # Test 3: Verify routes configuration\n    run_test \"Configuration - Routes setup\"\n    routes_config=$(curl -s \"$KONG_ADMIN_URL/services/$SERVICE_NAME/routes\")\n    \n    if echo \"$routes_config\" | grep -q \"$ROUTE_PATH\"; then\n        success \"Route configuration verified\"\n    else\n        fail \"Route configuration not found\"\n    fi\n}\n\n# =============================================================================\n# Cleanup Functions\n# =============================================================================\n\ncleanup_test_environment() {\n    log \"Cleaning up test environment...\"\n    \n    # Remove test consumer and associated keys\n    curl -s -X DELETE \"$KONG_ADMIN_URL/consumers/$CONSUMER_NAME\" > /dev/null || true\n    \n    # Clean up temporary files\n    rm -f /tmp/kong_test_response\n    rm -f /tmp/kong_concurrent_test_*\n    \n    success \"Cleanup completed\"\n}\n\n# =============================================================================\n# Results Summary\n# =============================================================================\n\nprint_summary() {\n    log \"=== TEST SUMMARY ===\"\n    echo \"\" | tee -a \"$RESULTS_FILE\"\n    echo \"Total Tests: $TOTAL_TESTS\" | tee -a \"$RESULTS_FILE\"\n    echo -e \"${GREEN}Passed: $PASSED_TESTS${NC}\" | tee -a \"$RESULTS_FILE\"\n    echo -e \"${RED}Failed: $FAILED_TESTS${NC}\" | tee -a \"$RESULTS_FILE\"\n    \n    local success_rate=0\n    if [ $TOTAL_TESTS -gt 0 ]; then\n        success_rate=$((PASSED_TESTS * 100 / TOTAL_TESTS))\n    fi\n    \n    echo \"Success Rate: $success_rate%\" | tee -a \"$RESULTS_FILE\"\n    echo \"\" | tee -a \"$RESULTS_FILE\"\n    \n    if [ $FAILED_TESTS -eq 0 ]; then\n        echo -e \"${GREEN}\ud83c\udf89 All tests passed! Kong migration is successful.${NC}\" | tee -a \"$RESULTS_FILE\"\n        exit 0\n    else\n        echo -e \"${RED}\u274c Some tests failed. Please review the configuration.${NC}\" | tee -a \"$RESULTS_FILE\"\n        exit 1\n    fi\n}\n\n# =============================================================================\n# Main Execution\n# =============================================================================\n\nmain() {\n    log \"Starting Kong Migration Test Suite for Petstore API\"\n    log \"Kong Admin URL: $KONG_ADMIN_URL\"\n    log \"Kong Proxy URL: $KONG_PROXY_URL\"\n    log \"Results will be saved to: $RESULTS_FILE\"\n    echo \"\"\n    \n    # Setup\n    setup_test_environment\n    \n    # Run all test suites\n    test_configuration\n    test_authentication\n    test_rate_limiting\n    test_cors\n    test_transformations\n    test_error_handling\n    test_security\n    test_performance\n    \n    # Cleanup and summary\n    cleanup_test_environment\n    print_summary\n}\n\n# =============================================================================\n# Script Entry Point\n# =============================================================================\n\n# Check if required tools are available\ncommand -v curl >/dev/null 2>&1 || { echo \"curl is required but not installed. Aborting.\" >&2; exit 1; }\ncommand -v grep >/dev/null 2>&1 || { echo \"grep is required but not installed. Aborting.\" >&2; exit 1; }\n\n# Handle script arguments\ncase \"${1:-}\" in\n    --help|-h)\n        echo \"Kong Migration Test Suite\"\n        echo \"\"\n        echo \"Usage: $0 [options]\"\n        echo \"\"\n        echo \"Options:\"\n        echo \"  --help, -h          Show this help message\"\n        echo \"  --setup-only        Only run setup, don't run tests\"\n        echo \"  --cleanup-only      Only run cleanup\"\n        echo \"\"\n        echo \"Environment Variables:\"\n        echo \"  KONG_ADMIN_URL      Kong Admin API URL (default: http://localhost:8001)\"\n        echo \"  KONG_PROXY_URL      Kong Proxy URL (default: http://localhost:8000)\"\n        echo \"\"\n        exit 0\n        ;;\n    --setup-only)\n        setup_test_environment\n        exit 0\n        ;;\n    --cleanup-only)\n        cleanup_test_environment\n        exit 0\n        ;;\n    *)\n        main\n        ;;\nesac\n```\n\nThis comprehensive test script includes:\n\n## **Key Features:**\n\n1. **Complete Test Coverage:**\n   - Authentication (API key validation, removal)\n   - Rate limiting (spike arrest, quotas)\n   - CORS handling\n   - Request/response transformations\n   - Error handling (401, 429, 404)\n   - Security tests (injection, XSS protection)\n   - Performance tests (latency, concurrency)\n   - Configuration validation\n\n2. **Robust Test Framework:**\n   - Colored output for better readability\n   - Detailed logging to results file\n   - Test counters and success rate calculation\n   - Proper error handling and cleanup\n\n3. **Flexible Configuration:**\n   - Environment variable support\n   - Command-line options\n   - Configurable URLs and parameters\n\n4. **Production-Ready:**\n   - Proper setup and teardown\n   - Concurrent request testing\n   - Security vulnerability checks\n   - Performance benchmarking\n\n## **Usage:**\n\n```bash\n# Make executable\nchmod +x kong_migration_test.sh\n\n# Run all tests\n./kong_migration_test.sh\n\n# Run with custom Kong URLs\nKONG_ADMIN_URL=http://kong-admin:8001 KONG_PROXY_URL=http://kong-proxy:8000 ./kong_migration_test.sh\n\n# Setup only\n./kong_migration_test.sh --setup-only\n\n# Cleanup only\n./kong_migration_test.sh --cleanup-only\n```\n\nThe script will generate a detailed results file and provide a comprehensive summary of the migration testing results.",
    "validation": {
        "errors": [
            "Invalid decK format: 'keyauth_credentials' and 'jwt_secrets' are not valid top-level entities in decK 3.0 format",
            "Multiple plugins with same name 'rate-limiting-advanced' at service level - Kong will only apply the last one",
            "Route 'show-pet-by-id' has invalid path '/petstore-api/pets/' - should be '/petstore-api/pets/{id}' or use regex",
            "Custom Lua code in pre-function plugin is too complex and may cause performance issues",
            "Response-transformer-advanced plugin configuration is invalid - 'functions' field doesn't exist",
            "Missing 'impose-quota' policy implementation - only rate limiting is configured, not quota management",
            "JWT plugin configuration missing required 'secret' or key resolution mechanism",
            "impose-quota policy - only rate limiting implemented, missing quota enforcement with different time windows",
            "Complete VerifyJWT policy configuration - missing proper key resolution and all JWT validation parameters"
        ],
        "is_valid": false,
        "suggestions": [
            "Use separate rate-limiting plugins with different instance names or combine into single configuration",
            "Implement proper consumer and credential management using Kong Admin API calls",
            "Consider using Kong's built-in request-validator plugin instead of custom Lua for JSON validation",
            "Use Kong's built-in request-termination plugin for SQL injection patterns",
            "Implement proper JWT key management with Kong's key-sets or JWKS",
            "Add request/response logging for better observability",
            "Consider using Kong's request-size-limiting plugin limits more granularly",
            "Add health check configuration for the upstream service",
            "Complex Lua code in pre-function will execute on every request - consider moving to dedicated plugin",
            "JSON parsing and validation in Lua may cause memory spikes with large payloads",
            "Multiple rate limiting plugins may cause redundant Redis calls",
            "Proxy cache with memory strategy may cause memory issues under high load",
            "Sliding window rate limiting is more resource-intensive than fixed window",
            "Consider using Kong's built-in validators instead of custom Lua for better performance"
        ],
        "warnings": [
            "Service URL 'http://petstore.swagger.io/v1' uses HTTP instead of HTTPS",
            "CORS plugin allows all origins ('*') which may be too permissive for production",
            "Default API key 'default-api-key-12345' is hardcoded and insecure",
            "Proxy-cache-advanced plugin may not exist in all Kong distributions - consider using 'proxy-cache'",
            "Rate limiting strategy 'cluster' requires Redis/PostgreSQL for multi-node deployments",
            "JSON validation logic in Lua is complex and may impact performance under load",
            "Missing error handling for malformed JSON in custom Lua code",
            "Hardcoded API key in configuration poses security risk",
            "JWT secret key placeholder 'your-secret-key-here' must be replaced with actual secure key",
            "SQL injection regex patterns are case-sensitive and may miss encoded attacks",
            "JSON threat protection limits may be bypassed with nested objects",
            "No input sanitization for path parameters in show-pet-by-id route",
            "Missing rate limiting on JWT-protected endpoint could allow token abuse",
            "CORS wildcard origin allows any domain to make requests"
        ]
    }
}
